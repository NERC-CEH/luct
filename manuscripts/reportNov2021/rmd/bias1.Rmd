
```{r render, eval = FALSE, echo = FALSE}
library(rmarkdown)
render("analysis/m_uqdata.Rmd", html_document())
render("analysis/m_uqdata.Rmd", word_document())
render("analysis/m_uqdata.Rmd", pdf_document())
bookdown::preview_chapter("bias1.Rmd")
system.time(bookdown::render_book("index.Rmd"))
```

```{r setup, echo = FALSE, include = FALSE}
# NOTE this notebook can be run manually or automatically by {targets}
# So load the packages required by this notebook here
# rather than relying on _targets.R to load them.

# Set up the project environment, because {workflowr} knits each Rmd file 
# in a new R session, and doesn't execute the project .Rprofile

library(targets) # access data from the targets cache
here::i_am("analysis/m_uqdata.Rmd")
library(tictoc) # capture execution time
library(here) # construct file paths relative to project root
library(fs) # file system operations
library(qs)
library(dplyr) # data wrangling
# install.packages("sn") # skewed normal distribution
#library(sn) # skewed normal distribution
library(tidyr)
library(data.table) # data wrangling
library(units)
library(ggplot2)
library(rmarkdown)
library(raster)
library(rgdal)
library(spCEH)
library(stars)
library(ggplot2)
library(scales)
library(RColorBrewer)
library(data.table)
theme_set(theme_classic())

lu_names <- c("woods", "crops", "grass", "rough", "urban", "other")

### Beth's Fpn function: I use this for doing the 0618 corine but use Pete's output for the rest of them just because
source("P:\\07643_Tracking_Land_Use\\LUC uncertainties\\luc_uncert_funct_27Sept.R")

# Load false positives and negatives from Pete's code
load("P:/07643_Tracking_Land_Use/LUC uncertainties/m_fp_fn.rda", verbose = TRUE)

#Code for BLAGs
source("P:/07643_Tracking_Land_Use/luct/R/luc_track.R")
source("P:/07643_Tracking_Land_Use/luct/R/luct.R")

# start the execution time clock
tictoc::tic("Computation time (excl. render)")

# dt_D <- tar_read(c_obs)$dt_D
# qsave(dt_D, "dt_D.qs")
dt_D <- qread(here("data", "dt_D.qs"))

```

# Quantifying Systematic Uncertainty in Land-Use Data Sources

## Introduction

The spatial datasets used in the data assimilation for Land Use Tracking will contain systematic errors, related to falsely detecting land-use change when it has not occurred, and missing true land-use change when it does occur.
To characterise uncertainties in the data, we want to quantify these false positive and false negative detection rates.
These can be estimated by comparison with a reference dataset, and thereby judging where the observed changes in a given data set are correctly identified or not.
For observations of the $B$ matrix, this is complicated by the fact that they form a 6 x 6-way classification. When considering land-use *change*, we need to compare the 36 elements of this classification from one data source with another (or the truth), so we have a 36 x 36 error matrix (or "confusion" matrix). This matrix has two distinct types of errors that we ideally want to distinguish: false positives and false negatives, or "user"/"commission" and "producer"/"omission" error/accuracy, in the terminology commonly used in remote sensing.

As with estimating random uncertainty, a limitation is that none of the data sources represents absolute truth, and we have no definitive data set against which to make this assessment.

### Representation of systematic uncertainty
Our approach here is to explicitly represent the false positive and false negative error terms in the likelihood function. False positives cause observations to over-estimate change, whilst false negatives produce an under-estimate, and the estimated bias in the observation is a simple function of these error rates ($F_P$ and $F_N$). The likelihood equation becomes:

\begin{equation} \label{eq:likBetaDelta}
 \mathcal{L} = \frac{1}{\sigma_{ij}^\mathrm{obs} \sqrt{2\pi}} \mathrm{exp}(-((1-F_P) \beta_{ij}^{\mathrm{obs}} + A_N F_N - \beta_{ij}^{\mathrm{pred}})^2/2 {\sigma_{ij}^\mathrm{obs}}^2)
\end{equation}

where $A_N$ is the area in which the false negative errors can occur, given by the number of grid cells where the land-use change $ij$ was not detected. This equation calculates the likelihood of the observed change from land use $i$ to land use $j$, given that the true value is $\beta_{ij}^{\mathrm{pred}}$, and with given false positive and false negative rates $F_P$ and $F_N$, and random uncertainty $\sigma_{ij}^\mathrm{obs}$ in the observation. This approach can be implemented in increasingly complex ways:

* estimating the false positive and false negative error rates based on some set of confusion matrices, and thereafter assuming them to be fixed and constant for a given data source;

* as above, but calculating false positive and false negative error rates specific to each type of land-use change (i.e. $F_{Pij}$ and $F_{Nij}$), and potentially vaying in time;

* including the false positive and false negative error rates as unknown parameters to be calibrated, along with the $B$ and $\sigma^{\mathrm{obs}}$ values. This is the most sophisticated solution, as it properly represents the fact that these are not truly known, and allows the values to be an emergent property of the data, given prior information, rather than imposing our guesses.  The exact number of these parameters to estimate could vary as above, whether specific to each data source, type of land-use change, and point in time.
    

## Methods
We explored the variability in false positive and false negative rates in the datasets at the land-use, data-source and time levels to identify the most appropriate way to account for uncertainty in the data assimilation. The definition of the reference data, calculation of false positives and negatives, and application of these values into the likelihood function is presented below.

```{r, functions, eval = TRUE, echo = FALSE}
getRMSE <- function(df = df, v, v_ref = "Ref"){
  v     <- df[[v]]
  v_ref <- df[[v_ref]]
  resid <- v - v_ref
  RMSE <- sqrt(mean(resid^2, na.rm = TRUE))
  # if no data, these will be NaN, which need to be NA
  RMSE[is.nan(RMSE)] <- NA
  return(RMSE)
}

get_cor <- function(df = df, v = "CORINE", v_ref = "Ref"){
  v     <- df[[v]]
  v_ref <- df[[v_ref]]
  r2 <- cor(v, v_ref, use = "pairwise.complete.obs")
  r2
  # if no data, these will be NaN, which need to be NA
  r2[is.nan(r2)] <- NA
  return(r2)
}
```

```{r, loading, eval = FALSE, echo = FALSE}
# load(file = here::here("data-raw", "blags_100m.RData"), verbose = TRUE)
# dt_D <- dt_dA_obs
```

```{r, plot_ts, eval = FALSE, echo = FALSE}
# D time series
#dt_D$area <- drop_units(dt_D$area)
p <- ggplot(dt_D[time > 1990 & time < 2020 & area != 0], 
  aes(time, area, colour = data_source))
p <- p + geom_line()
p <- p + geom_point()
p <- p + ggtitle("Net Change in Area in UK")
p <- p + ylab(expression(paste(Area*", "*~km^2/y)))
p <- p + geom_hline(yintercept = 0)
p <- p + facet_wrap(~ u, scales = "free_y")
p
```

```{r, metrics, eval = FALSE, echo = FALSE}
df <- pivot_wider(dt_D, names_from = data_source, values_from = area)
df <- subset(df, time >= 1990 & time <= 2020)
df$Ref <- df$AgCensus
df$Ref[df$u == "woods"] <- df$FC[df$u == "woods"]

v_names_sources = c("AgCensus", "CS", "FC", "LCM", "CORINE", "LCC", "IACS", "CROME")
v_rmse <- sapply(v_names_sources, getRMSE, df = df, v_ref = "Ref")
v_r2   <- sapply(v_names_sources, get_cor, df = df, v_ref = "Ref")

df_scaling_uncert <- data.frame(RMSE = v_rmse, r2 = v_r2, 
  # reduce RMSE proportional to r2, so that abs and prop measures contribute to sigma weighting
  sigma = v_rmse * abs(1 - v_r2))

df_scaling_uncert <- df_scaling_uncert[order(df_scaling_uncert$sigma),]
# AgCensus and FC form the reference, so are rows 1:2 when ordered
# guess sigma for these as half the lowest value, which will be row 3 
# very arbitrary assumption, to be improved upon
df_scaling_uncert["AgCensus",]$sigma <- df_scaling_uncert[3,]$sigma * 0.5
df_scaling_uncert["FC",]$sigma       <- df_scaling_uncert[3,]$sigma * 0.5

# add dummy values for false positive and neg rates
df_scaling_uncert$Fp <- 0
df_scaling_uncert$Fn <- 0

knitr::kable(df_scaling_uncert)
qsave(df_scaling_uncert, file = here("data", "df_scaling_uncert.qs"))
```


```{r, plot_correspondence, eval = FALSE, echo = FALSE, warning=FALSE}
# Plot correspondence
p <- ggplot(df, aes(LCC, CROME, colour = u))
#p <- ggplot(df, aes(AgCensus, IACS, colour = u))
p <- p + geom_point()
p <- p + stat_smooth(method = "lm")
p <- p + geom_abline()
p <- p + facet_wrap(~ u, scales = "free_y")
p
```

### Creating reference datasets:
We created the reference data by combining several spatially explicit data sources that are thought to have the highest accuracy and reliability for certain land use types, namely FC, IACS and LCM. These data-sources were added to the reference dataset in order of expected reliability: land use defined in FC data took precedence over IACS, followed by LCM. This resulted in a reference dataset that includes the majority of forest cells from FC, the majority of crop, grass and rough grazing from IACS and the majority of urban and other cells from LCM. 
This reference data was used to compare the other data-sources against (LCC, CORINE, CROME). In order to test FC, IACS and LCM themselves, we removed the respective dataset from the reference data, and tested land-use change classifications against those present in the remaining reference data (e.g. testing the forest, crop, grassland or rough grazing land-use change in IACS against that defined in FC and LCM).

This method enabled us to build reference rasters for England for 2006, 2010, 2015, 2017, 2018 and 2019. The 2010 reference raster comprising FC, IACS and LCM data is shown below, as well as the 2010 reference raster for testing IACS (comprising FC and LCM data).

```{r, echo=FALSE, warning= FALSE, fig.align="default", fig.show="hold", out.width="50%"} 

ref_2010_all <- raster("P:/07643_Tracking_Land_Use/LUC uncertainties/reference rasters/r_ref_100m_all_2010.tif")

plot(ref_2010_all, main = "Reference data 2010 (FC, IACS and LCM)")


ref_2010_iacs <- raster("P:/07643_Tracking_Land_Use/LUC uncertainties/reference rasters/r_ref_100m_IACS_2010.tif")

plot(ref_2010_iacs, main = "Reference data 2010 (FC and LCM only)")
```
The table below shows the reference data used for each data source:

```{r reference data table, echo=FALSE}
Dataset <- c("FC", "IACS", "LCM", "LCC", "CORINE", "CROME")
Reference <- c("IACS, LCM", "FC, LCM", "FC, IACS", rep("FC, IACS, LCM", 3))
ref_table <- data.frame(cbind(Dataset, Reference))
knitr::kable(ref_table)
```


Each data source was tested against its appropriate reference data according to the table above. The resulting 36*36 confusion matrix quantifies the correspondence between the data sets, in terms of their agreement over the area of each land use changing to every other land use. The diagonal identifies the area of land-use change that was identified to occur in both the reference and test data sets. The unchanging land on the diagonal can be disregarded as not relevant here. 

### False positive rates
The false positive rate was calculated as: 

$F_{Pij}$ = ($\beta_{test,ij}$ - $\beta_{ref,ij}$)/ $\beta_{test,ij}$

where $\beta_{test,ij}$ is the observed area of land changing from use $i$ to $j$ in the test dataset and $\beta_{ref,ij}$ the corresponding value in the reference dataset.

### False negative rates
The false negative rate, the rate of failing to observe land-use change from $i$ to $j$ in the test dataset compared to the reference dataset, was calculated as:

$F_{Nij}$ = ($\beta_{ref,ij}$ - $\beta_{ref,test,ij}$)/ ($A$ - $\beta_{test,ij}$)

where $\beta_{ref,test,ij}$ is the area of land changing from $i$ to $j$ identified in both the reference and test data sets, and $A$ is the total area of England. The denominator is thus the total land area where false negatives could occur.

## Results
Here we use CORINE as an example showing the false positive and negative rates calculated between the data source and the reference dataset between 2006 and 2018 (most recent years available for comparison). The data shows the trend across all of the data-sources: very high false positive rates, with slightly lower false positive rates for the land-use change between crop and grassland. False negative rates were much lower, but are expressed on a very different basis, and not directly comparable. The matrices below show the false positive/negative rate for each land-use change between the first year (row) and the second year (column).

False positive rates for CORINE between 2006 and 2018:

```{r confusion matrices fp, echo=FALSE, warning=FALSE}

corine_1km_BR <- luc_false_pn("CORINE", 2006, 2018, "1000m")
corine_fp <- round(corine_1km_BR$m_output_posrate[-7,-7], digits=3)
colnames(corine_fp) <- lu_names
rownames(corine_fp) <- lu_names
diag(corine_fp) <- ""
knitr::kable(corine_fp)
```

False negative rates for CORINE between 2006 and 2018:

```{r confusion matrices fn, echo=FALSE, warning=FALSE}

corine_fn <- round(corine_1km_BR$m_output_negrate[-7,-7], digits=3)
colnames(corine_fn) <- lu_names
rownames(corine_fn) <- lu_names
diag(corine_fn) <- ""
knitr::kable(corine_fn)
```

The following graphs show the false positive and false negative rates for each data source, with the grid of graphs showing the land use type in the first year and colour showing the land use in the second year.

False positive rates:
```{r graphing false positives, echo= FALSE, warning=FALSE}

df_iacs <- as.data.frame(iacs_1km_PL$m_fp)
df_lcc <- as.data.frame(lcc_1km_PL$m_fp)
df_lcm <- as.data.frame(lcm_1km_PL$m_fp)
df_corine <- as.data.frame(corine_1km_PL$m_fp)
df_crome <- as.data.frame(crome_1km_PL$m_fp)
df_iacs$model <- "IACS"
df_lcc$model <- "LCC"
df_lcm$model <- "LCM"
df_corine$model <- "CORINE"
df_crome$model <- "CROME"

df_all_fp <- rbind(df_iacs, df_lcc, df_lcm, df_corine, df_crome)
df_all_fp <- df_all_fp[!is.na(df_all_fp$Freq),]
df_all_fp <- df_all_fp[df_all_fp$Freq>0,]

ggplot(df_all_fp, aes(x=model, y= Freq, colour= Var2)) +
  geom_jitter(width=0.1) +
  facet_wrap(.~ Var1) +
  scale_y_continuous(limits=c(0,1)) +
  ylab("False positive rate") +
  xlab("Data source") +
  scale_color_brewer(palette="Dark2", name="Land use\n2nd yr") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


```

False negative rates:
```{r graphing false negatives, echo=FALSE}

df_iacs <- as.data.frame(iacs_1km_PL$m_fn)
df_lcc <- as.data.frame(lcc_1km_PL$m_fn)
df_lcm <- as.data.frame(lcm_1km_PL$m_fn)
df_corine <- as.data.frame(corine_1km_PL$m_fn)
df_crome <- as.data.frame(crome_1km_PL$m_fn)
df_iacs$model <- "IACS"
df_lcc$model <- "LCC"
df_lcm$model <- "LCM"
df_corine$model <- "CORINE"
df_crome$model <- "CROME"

df_all <- rbind(df_iacs, df_lcc, df_lcm, df_corine, df_crome)
df_all <- df_all[!is.na(df_all$Freq),]
df_all <- df_all[df_all$Freq>0,]

ggplot(df_all, aes(x=model, y= Freq, colour= Var2)) +
  geom_jitter(width=0.1) +
  facet_wrap(.~ Var1) +
  scale_y_continuous(limits=c(0,0.06)) +
  ylab("False negative rate") +
  xlab("Data source") +
  scale_color_brewer(palette="Dark2", name="Land use\n2nd yr") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

### Data-source-specific false positive and false negative rates

Based on the relatively low variability in false positive rates identified for many of the land-use change classes, we chose to summarise false positive rates at the data-source level rather than land-use level. Data-set level false positive rates were calculated as an average of the land-use level false positive rate, weighted by area of each land-use change. 

This gave the following outputs which can be incorporated into the data assimilation method:
```{r dataset level fpn, echo=FALSE}
# table where I have calculated the average false positives and negatives, haven't included code here:
df_fpn <- read.csv("P:\\07643_Tracking_Land_Use\\LUC uncertainties\\df_fpn.csv", row.names = 1)
colnames(df_fpn)[1] <- "Data source"
knitr::kable(df_fpn)

```

### Updating $B, D, G$ and $L$

To examine the effect of these systematic biases on the observations, we can recalculate the $B$ transition matrix. An example is provided below for IACS from 2005 to 2019:

```{r updating BLAG, echo=FALSE, warning= FALSE}

# doing this manually here because I cant get get_uncert, add_uncert to work on my computer

iacs_files <- list.files("P:/07643_Tracking_Land_Use/luct/data/IACS/Level1/")
iacs_1km <- iacs_files[16:30]
BLAG_iacs <- getBLAG_fromU(v_times= c(2005:2019),
                    v_fnames=c(paste0("P:/07643_Tracking_Land_Use/luct/data/IACS/Level1/", iacs_1km)),
                    name_data_source="IACS",
                    names_u =names_u)


# multiply beta matrix by false positive rate for IACS
BLAG_iacs$a_B <- BLAG_iacs$a_B * (1 - df_fpn[5,3])

BLAG_iacs2 <- getBLAG(BLAG_iacs$a_B, names_u = names_u, name_data_source="IACS")

dt_D <- BLAG_iacs$dt_D
dt_D2 <- BLAG_iacs2$dt_D
dt_D$when <- "before"
dt_D2$when <- "after"
dt_D2$time <- dt_D2$time + 2003

dt_D_all <- rbind(dt_D, dt_D2)
dt_D_all$time <- as.numeric(as.character(dt_D_all$time))
dt_D_all <- dt_D_all[-c(62:70, 77:85, 152:160, 166:175)]
ggplot(dt_D_all, aes(x=time, y=area/1000000, colour=when)) +
  geom_point() +
  geom_line() +
  scale_y_continuous(labels=comma) +
  xlab("Land use") +
  ylab("Net change in area (km2)") +
  facet_wrap(.~u) +
  scale_x_continuous(limits=c(2005,2019), breaks=c(2006, 2010, 2014, 2018)) +
  scale_colour_brewer(palette="Dark2", name="Fp correction", labels=c("Y", "N"))

```


## Conclusions

* We can represent data source-specific systematic uncertainty by estimating appropriate false positive and false negative rates for each data source, and adding these terms to the likelihood function.
* Again, the most fundamental problem is the absence of any data which we regard as "true". There is no immediate solution to this, and a pragmatic approach is to define a reference data set, with more or less subjectivity/expert judgement, and principles from cross-validation.
* False positive rates appear to be very high, but are consistently so across most of the land-use categories. With this in mind, we use data-set level $Fp$ and $Fn$ values rather than land-use level values. 

```{r echo=FALSE}
tictoc::toc()
```
