# Results: Wales
<!--- { rendering -->
```{r, render_book, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
bookdown::render_book("index.Rmd")
bookdown::preview_chapter("Results_wa.Rmd")
setwd("manuscripts/reportNov2021/rmd")
```
<!--- } -->

The figures below show the results of the data assimilation procedure. All the data sets shown were used in the algorithm, but their relative random uncertainties ($\sigma$) determined how much influence they have on the estimates. The spatial data sets were corrected for systematic uncertainties, using the estimated net false positive rate ($F_P$). Having estimated the posterior distribution of the $\beta$ matrix, we used this to simulate multiple maps of land use going back in time to 1950. The maps of the likelihood of transition to each land use established in WP-A were updated dynamically, using the life tables described in Section 5.


```{r, setup, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
library(here)
library(targets)
library(qs)
library(dplyr)
library(data.table)
library(tidyr)
library(stringr)
library(stringi)
library(ggplot2)
library(ggthemes)
library(spCEH)
library(stars)

here::i_am("manuscripts/reportNov2021/rmd/Results_wa.Rmd")
source(here("R", "luc_track.R"))

tar_load(c_post_B_wa, store = "../../../_targets")
#print(ls.str(c_post_B_wa), max.level = 0)

c_post_B_wa$p_B$theme  <- ggplot2::theme_minimal()
c_post_B_wa$p_G$theme  <- ggplot2::theme_minimal()
c_post_B_wa$p_L$theme  <- ggplot2::theme_minimal()
c_post_B_wa$p_D$theme  <- ggplot2::theme_minimal()
```

```{r, make_maps_wa, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
region <- "wa"
dir_output <- paste0("output/output_", region)
i_sample <- 1
res <- 1000
fname <- here(dir_output, paste0("dt_luv_", region, "_smp", i_sample, "_", res, "m.qs"))
dt_luv <- qread(file = fname)
v_times <- dt_luv$start_time[1]:dt_luv$end_time[1]
n_t <- length(v_times)

# re-read file in if needed
fname <- here(dir_output, paste0("dt_u_", region, "_smp", i_sample, "_", res, "m.qs"))
dt <- qread(file = fname)


# remove the six vectors with no change
ind_unchanging <- c(
  str_which(dt_luv$u_ch, "1{71}"),
  str_which(dt_luv$u_ch, "2{71}"),
  str_which(dt_luv$u_ch, "3{71}"),
  str_which(dt_luv$u_ch, "4{71}"),
  str_which(dt_luv$u_ch, "5{71}"),
  str_which(dt_luv$u_ch, "6{71}")
)
dt_luv <- dt_luv[-ind_unchanging]

# identify to crop-grass rotational vectors
ind_cgc <- str_which(dt_luv$u_ch, "2+3+2+")
ind_gcg <- str_which(dt_luv$u_ch, "3+2+3+")

dt_luv$id <- as.integer(rownames(dt_luv))

dt_luv_wide <- dt_luv %>% separate(u_ch, into = as.character(v_times), sep = 1:(n_t-1), convert = TRUE, remove = FALSE)
#names(dt_luv_wide)
dt_luv_long <- 
  pivot_longer(dt_luv_wide, cols = as.character(v_times), names_to = "time", values_to = "u")
#names(dt_luv_long)
dt_luv_long$time <- as.integer(dt_luv_long$time)

p <- ggplot(subset(dt_luv_long, id < 100), aes(time, u))
# use this for rotational crop-grass
#p <- ggplot(subset(dt_luv_long, id %in% ind_cgc ), aes(time, u))
p <- p + geom_path(aes(size = area, alpha = area, colour = as.factor(id)))
p <- p + scale_y_continuous(breaks = 1:6, labels = names_u)
p <- p + xlab("Year") + ylab("Land use")
p <- p + guides(colour=FALSE, alpha=FALSE, size=FALSE)
p_v1 <- p

p <- ggplot(subset(dt_luv_long, id >= 1 & id <= 42), aes(time, u))
#p <- ggplot(subset(dt_luv_long, id %in% ind_cgc & area > 1), aes(time, u))
#p <- p + geom_path(aes(size = area_lu_vector, colour = as.factor(id)))
p <- p + geom_path(aes(size = area))
p <- p + scale_y_continuous(breaks = 1:6, labels = names_u)
p <- p + facet_wrap( ~ id, scales = "fixed")
p <- p + guides(colour=FALSE)
p <- p + xlab("Year") + ylab("Land use")
p <- p + scale_x_continuous(breaks=c(1960,2000))
p <- p + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p_v2 <- p

# rotational crop-grass
p <- ggplot(subset(dt_luv_long, id %in% ind_cgc | id %in% ind_cgc ), aes(time, u))
p <- p + geom_path(aes(size = area, alpha = area, colour = as.factor(id)))
p <- p + scale_y_continuous(breaks = 1:6, labels = names_u)
p <- p + xlab("Year") + ylab("Land use")
p <- p + guides(colour=FALSE, alpha=FALSE, size=FALSE)
p_cgr <- p

# choose years for change 
times_achangin <- c(2010, 2020)
v_t <- match(times_achangin, v_times)
dt[, u_t1 := factor(substr(u_ch, v_t[1], v_t[1]), levels = 1:n_u)]
dt[, u_t2 := factor(substr(u_ch, v_t[2], v_t[2]), levels = 1:n_u)]
dt[, u_t2 := factor(substr(u_ch, v_t[2], v_t[2]), levels = 1:n_u)]
dt[, u_t12 :=  as.factor(paste0(u_t1, u_t2))]
# table(dt$u_t12)
dt[u_t1 == u_t2, u_t12 := NA]
dt[is.na(u_ch), u_t12 := NA]
  
r <- getRasterTemplate(domain = "UK", res = res, crs = crs_OSGB)
r_u_t1   <- setValues(r, dt[, u_t1])
r_u_t2   <- setValues(r, dt[, u_t2])
r_u_t12  <- setValues(r, dt[, u_t12])

dt_plot <- as.data.table(as.data.frame(r_u_t12, xy = TRUE))
dt_plot <- data.table(dt_plot, dt[, .(u_t1, u_t2)])
names(dt_plot)[3] <- "u_u"
dt_plot <- dt_plot[!is.na(u_u)]
dt_plot <- dt_plot[!is.na(u_t1)]
dt_plot <- dt_plot[u_t1 != u_t2]

#p <- ggplot(data = dt_plot[sample(1:dim(dt_plot)[1], 2000)], aes(x,y)) + 
p_u_d <- ggplot(data = dt_plot[sample(1:dim(dt_plot)[1], 1500)], aes(x,y)) + 
  geom_point(aes(colour = u_t1), shape = "square", size = 3) +
  geom_point(aes(colour = u_t2), shape = "circle", size = 1.5) +
  scale_colour_manual(name = "Square = previous \n Circle = new", values = colour_u, labels = names_u) #+
  #coord_equal() +  theme_map() +  theme(legend.position = "right")

s <- stack(r_u_t1, r_u_t2)
st_U <- st_as_stars(s)
st_U <- st_set_dimensions(st_U, "band", values = times_achangin, names = "time")
names(st_U) <- "U"
st_U$U <- factor(st_U$U)
levels(st_U) <- names_u
#plot(st_U, interpolate = TRUE)

p_u_t <- ggplot() + 
  geom_stars(data = st_U[,,, c(1, 2)], 
  downsample = c(1, 1, 1)) + 
  facet_wrap("time") +
  scale_fill_manual(values = colour_u, labels = names_u) +
  coord_equal() +  theme_map() +
  theme(legend.position = "right")  
```

```{r, plotB, out.width = "130%", eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.cap=" Observations and posterior distribution of the transition matrix $\\mathbf{B}$, representing the gross area changing from the land use in each row to the land use in each column each year from 1950 to 2020. The grey shaded band shows the 2.5 and 97.5 percentiles of the posterior distribution. The maximum *a posteriori* estimate is shown as the solid black line within this. Observations from the different data sources are shown as coloured circles. The coloured solid lines show the corrected observations after accounting for systematic uncertainties, and interpolating. The coloured bands around these lines show the random uncertainty, rescaled as $\\sigma /5$ to keep with the axis scale. Because the random uncertainties and the corrections to the observations are generally very large in comparison to the actual change, scaling the axes is difficult. Note that a consistent colour scheme for the data sources is shown, but not all contribute to every figure."}
c_post_B_wa$p_B + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + scale_x_continuous(breaks=c(1960,2000))
```

```{r, plotG, out.width = "130%", eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.cap=" Observations and posterior distribution of the gross gain in area of each land use $\\mathbf{G}$ from 1950 to 2020.  The grey shaded band shows the 2.5 and 97.5 percentiles of the posterior distribution. The maximum *a posteriori* estimate is shown as the solid black line within this. Observations from the different data sources are shown as coloured circles. The coloured solid lines show the corrected observations after accounting for systematic uncertainties, and interpolating. The coloured bands around these lines show the random uncertainty, rescaled as $\\sigma /5$ to keep with the axis scale. Because the random uncertainties and the corrections to the observations are generally very large in comparison to the actual change, scaling the axes is difficult. Note that a consistent colour scheme for the data sources is shown, but not all contribute to every figure."}
c_post_B_wa$p_G + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + scale_x_continuous(breaks=c(1960,2000))
```

```{r, plotL, out.width = "130%", eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.cap=" Observations and posterior distribution of the gross loss of area from each land use $\\mathbf{L}$ from 1950 to 2020.  The grey shaded band shows the 2.5 and 97.5 percentiles of the posterior distribution. The maximum *a posteriori* estimate is shown as the solid black line within this. Observations from the different data sources are shown as coloured circles. The coloured solid lines show the corrected observations after accounting for systematic uncertainties, and interpolating. The coloured bands around these lines show the random uncertainty, rescaled as $\\sigma /5$ to keep with the axis scale. Because the random uncertainties and the corrections to the observations are generally very large in comparison to the actual change, scaling the axes is difficult. Note that a consistent colour scheme for the data sources is shown, but not all contribute to every figure."}
c_post_B_wa$p_L + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + scale_x_continuous(breaks=c(1960,2000))
```

```{r, plotD, out.width = "130%", eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.cap=" Time series of the net change in area occupied by each land use ($D$) from 1950 to 2020, showing the observations and posterior distribution of estimates. The grey shaded band shows the 2.5 and 97.5 percentiles of the posterior distribution. The maximum *a posteriori* estimate is shown as the solid black line within this. Observations from the different data sources are shown as coloured circles. The coloured solid lines show the corrected observations after accounting for systematic uncertainties, and interpolating. The coloured bands around these lines show the random uncertainty, rescaled as $\\sigma /5$ to keep with the axis scale. Because the random uncertainties and the corrections to the observations are generally very large in comparison to the actual change, scaling the axes is difficult. Note that a consistent colour scheme for the data sources is shown, but not all contribute to every figure."}
c_post_B_wa$p_D + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + scale_x_continuous(breaks=c(1960,2000))
```


```{r, plotUt, out.width = "130%", eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Estimated state of land-use in 2010 and 2020 in one realisation of $U$ from the maximum *a posteriori* estimate of $B$."}
  p_u_t  
```

```{r, plotUd, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="The spatial distribution of land-use change between 2010 and 2020 in one realisation of $U$ from the maximum *a posteriori* estimate of $B$. At each location where land use has changed, the use in 2010 is shown as a coloured square, and the use in 2020 is shown as a coloured circle within this"}
  p_u_d
```

```{r, plotv1, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Trajectories of the 100 land-use vectors in the posterior $U$ with the largest areas (excluding the six vectors which show no change). Each vector of land use is shown in a different colour, varied arbitrarily to differentiate different vectors. Line thickness and opacity are proportional to the total area occupied by each vector, so that the dominant vectors are the most visually obvious."}
  p_v1
```

```{r, plotv2, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Trajectories of the 42 land-use vectors in the posterior $U$ with the largest areas (excluding the six vectors which show no change). Line thickness is proportional to the total area occupied by each vector."}
  p_v2
```

```{r, plotcgr, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Trajectories of the land-use vectors in the posterior $U$ which involve rotational change between crop and grassland (i.e. those which include either (i) transitions from crop to grass and then subsequently from grass to crop, *or* (ii) transitions from grass to crop and then subsequently from crop to grass). Each vector of land use is shown in a different colour, varied arbitrarily to differentiate different vectors. Line thickness and opacity are proportional to the total area occupied by each vector, so that the dominant vectors are the most visually obvious."}
  p_cgr
```
